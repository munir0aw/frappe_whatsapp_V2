{% extends "templates/web.html" %}

{% block title %}Conversation - WhatsApp Portal{% endblock %}

{% block page_content %}

{% if no_access %}
<div style="text-align: center; padding: 60px 20px;">
	<div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
	<h2>Access Denied</h2>
	<p>{{ message }}</p>
	<a href="/whatsapp" class="btn btn-primary" style="margin-top: 20px;">Back to Conversations</a>
</div>
{% else %}

<style>
	.conversation-container {
		display: flex;
		height: calc(100vh - 80px);
		background-color: #f5f7fa;
	}

	.conversation-main {
		flex: 1;
		display: flex;
		flex-direction: column;
		background-color: white;
		border-radius: 8px;
		margin: 20px;
		overflow: hidden;
		box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
	}

	/* Header */
	.conversation-header {
		padding: 16px 24px;
		border-bottom: 1px solid #e5e7eb;
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.conversation-info {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.back-btn {
		padding: 8px;
		background: transparent;
		border: none;
		cursor: pointer;
		font-size: 20px;
	}

	.contact-name {
		font-size: 18px;
		font-weight: 600;
		color: #1c1f37;
	}

	.contact-status {
		font-size: 14px;
		color: #6b7280;
	}

	.conversation-actions {
		display: flex;
		gap: 12px;
	}

	.action-btn {
		padding: 8px 16px;
		border: 1px solid #e5e7eb;
		background-color: white;
		border-radius: 6px;
		font-size: 14px;
		cursor: pointer;
		transition: all 0.2s;
	}

	.action-btn:hover {
		background-color: #f9fafb;
	}

	.action-btn-primary {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		border: none;
	}

	.action-btn-primary:hover {
		opacity: 0.9;
	}

	/* Messages Area */
	.messages-area {
		flex: 1;
		overflow-y: auto;
		padding: 24px;
		background-color: #f5f7fa;
	}

	.message {
		display: flex;
		margin-bottom: 16px;
		animation: fadeIn 0.3s;
	}

	@keyframes fadeIn {
		from { opacity: 0; transform: translateY(10px); }
		to { opacity: 1; transform: translateY(0); }
	}

	.message.incoming {
		justify-content: flex-start;
	}

	.message.outgoing {
		justify-content: flex-end;
	}

	.message-bubble {
		max-width: 60%;
		padding: 12px 16px;
		border-radius: 12px;
		position: relative;
	}

	.message.incoming .message-bubble {
		background-color: white;
		border: 1px solid #e5e7eb;
	}

	.message.outgoing .message-bubble {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
	}

	.message-text {
		font-size: 14px;
		line-height: 1.5;
		word-wrap: break-word;
	}

	.message-meta {
		display: flex;
		align-items: center;
		gap: 8px;
		margin-top: 4px;
		font-size: 12px;
		opacity: 0.7;
	}

	.message-time {
		font-size: 11px;
	}

	.message.outgoing .message-meta {
		justify-content: flex-end;
	}

	.star-btn {
		background: transparent;
		border: none;
		cursor: pointer;
		font-size: 16px;
		padding: 0;
		margin-left: 8px;
	}

	.star-btn.starred {
		color: #fbbf24;
	}

	.message-media {
		margin-bottom: 8px;
		border-radius: 8px;
		overflow: hidden;
		max-width: 300px;
	}

	.message-media img {
		width: 100%;
		display: block;
	}

	/* Lead Panel */
	.lead-panel {
		padding: 20px;
		background-color: #eef2ff;
		border-left: 4px solid #667eea;
		margin-bottom: 16px;
		border-radius: 8px;
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.lead-info {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.lead-icon {
		font-size: 32px;
	}

	.lead-text h4 {
		margin: 0 0 4px 0;
		font-size: 16px;
		color: #1c1f37;
	}

	.lead-text p {
		margin: 0;
		font-size: 14px;
		color: #6b7280;
	}

	/* Lead Modal */
	.modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgba(0, 0, 0, 0.5);
		display: none;
		align-items: center;
		justify-content: center;
		z-index: 1000;
	}

	.modal-overlay.active {
		display: flex;
	}

	.modal {
		background: white;
		border-radius: 12px;
		padding: 24px;
		max-width: 500px;
		width: 90%;
		max-height: 90vh;
		overflow-y: auto;
	}

	.modal-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 20px;
	}

	.modal-title {
		font-size: 20px;
		font-weight: 600;
		color: #1c1f37;
	}

	.modal-close {
		background: transparent;
		border: none;
		font-size: 24px;
		cursor: pointer;
		color: #6b7280;
	}

	.form-group {
		margin-bottom: 16px;
	}

	.form-label {
		display: block;
		font-size: 14px;
		font-weight: 500;
		color: #374151;
		margin-bottom: 6px;
	}

	.form-input,
	.form-textarea {
		width: 100%;
		padding: 10px 12px;
		border: 1px solid #e  5e7eb;
		border-radius: 6px;
		font-size: 14px;
		outline: none;
	}

	.form-input:focus,
	.form-textarea:focus {
		border-color: #667eea;
	}

	.form-textarea {
		resize: vertical;
		min-height: 100px;
	}

	.empty-state {
		text-align: center;
		padding: 60px 20px;
		color: #6b7280;
	}

	.loading-spinner {
		display: inline-block;
		width: 40px;
		height: 40px;
		border: 4px solid #f3f4f6;
		border-top-color: #667eea;
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}

	@keyframes spin {
		to { transform: rotate(360deg); }
	}
</style>

<div class="conversation-container">
	<div class="conversation-main">
		<!-- Header -->
		<div class="conversation-header">
			<div class="conversation-info">
				<button class="back-btn" onclick="window.location.href='/whatsapp'">‚Üê</button>
				<div>
					<div class="contact-name">{{ contact.contact_name or contact.mobile_no }}</div>
					<div class="contact-status">{{ contact.qualification_status }}</div>
				</div>
			</div>
			<div class="conversation-actions">
				<button class="action-btn" id="refresh-btn">üîÑ Refresh</button>
				{% if not contact.converted_to_lead %}
				<button class="action-btn-primary action-btn" id="create-lead-btn">+ Create Lead</button>
				{% else %}
				<a href="/app/crm-lead/{{ contact.lead_reference }}" class="action-btn">View Lead ‚Üí</a>
				{% endif %}
			</div>
		</div>

		<!-- Messages Area -->
		<div class="messages-area" id="messages-area">
			<div class="empty-state">
				<div class="loading-spinner"></div>
				<div style="margin-top: 16px;">Loading messages...</div>
			</div>
		</div>
	</div>
</div>

<!-- Create Lead Modal -->
<div class="modal-overlay" id="lead-modal">
	<div class="modal">
		<div class="modal-header">
			<h3 class="modal-title">Create CRM Lead</h3>
			<button class="modal-close" onclick="closeLeadModal()">√ó</button>
		</div>
		<form id="lead-form">
			<div class="form-group">
				<label class="form-label">First Name *</label>
				<input type="text" class="form-input" id="first_name" required value="{{ contact.contact_name or '' }}">
			</div>
			<div class="form-group">
				<label class="form-label">Mobile Number *</label>
				<input type="text" class="form-input" id="mobile_no" value="{{ contact.mobile_no }}" readonly>
			</div>
			<div class="form-group">
				<label class="form-label">Email</label>
				<input type="email" class="form-input" id="email">
			</div>
			<div class="form-group">
				<label class="form-label">Company</label>
				<input type="text" class="form-input" id="company">
			</div>
			<div class="form-group">
				<label class="form-label">Notes</label>
				<textarea class="form-textarea" id="notes">{{ contact.conversation_summary or '' }}</textarea>
			</div>
			<button type="submit" class="action-btn-primary action-btn" style="width: 100%;">Create Lead</button>
		</form>
	</div>
</div>

<script>
	const contactId = "{{ contact.name }}";
	let messages = [];

	$(document).ready(function() {
		loadMessages();
		setupEventListeners();
	});

	function setupEventListeners() {
		// Refresh button
		$('#refresh-btn').on('click', loadMessages);

		// Create lead button
		$('#create-lead-btn').on('click', function() {
			$('#lead-modal').addClass('active');
		});

		// Lead form submission
		$('#lead-form').on('submit', function(e) {
			e.preventDefault();
			createLead();
		});

		// Close modal on overlay click
		$('#lead-modal').on('click', function(e) {
			if (e.target === this) {
				closeLeadModal();
			}
		});
	}

	function loadMessages() {
		frappe.call({
			method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.get_conversation_messages',
			args: { contact_id: contactId },
			callback: function(r) {
				if (r.message) {
					messages = r.message;
					renderMessages(r.message);
				}
			},
			error: function() {
				$('#messages-area').html(`
					<div class="empty-state">
						<div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
						<div>Failed to load messages</div>
					</div>
				`);
			}
		});
	}

	function renderMessages(msgs) {
		if (msgs.length === 0) {
			$('#messages-area').html(`
				<div class="empty-state">
					<div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
					<div>No messages yet</div>
				</div>
			`);
			return;
		}

		let html = '';

		msgs.forEach(msg => {
			const type = msg.type === 'Incoming' ? 'incoming' : 'outgoing';
			const time = moment(msg.creation).format('HH:mm');
			const starIcon = msg.is_starred ? '‚≠ê' : '‚òÜ';
			const starClass =msg.is_starred ? 'starred' : '';

			let mediaHtml = '';
			if (msg.attach && (msg.content_type === 'image' || msg.content_type === 'video' || msg.content_type === 'document')) {
				if (msg.content_type === 'image') {
					mediaHtml = `<div class="message-media"><img src="${msg.attach}" alt="Image"></div>`;
				} else {
					mediaHtml = `<div class="message-media"><a href="${msg.attach}" target="_blank">üìé ${msg.content_type}</a></div>`;
				}
			}

			html += `
				<div class="message ${type}">
					<div class="message-bubble">
						${mediaHtml}
						<div class="message-text">${escapeHtml(msg.message || '')}</div>
						<div class="message-meta">
							<span class="message-time">${time}</span>
							<button class="star-btn ${starClass}" onclick="toggleStar('${msg.name}')" data-starred="${msg.is_starred}">${starIcon}</button>
						</div>
					</div>
				</div>
			`;
		});

		$('#messages-area').html(html);
		
		// Scroll to bottom
		const messagesArea = document.getElementById('messages-area');
		messagesArea.scrollTop = messagesArea.scrollHeight;
	}

	function toggleStar(messageId) {
		frappe.call({
			method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.toggle_star_message',
			args: { message_id: messageId },
			callback: function(r) {
				if (r.message) {
					loadMessages(); // Reload to update star status
				}
			}
		});
	}

	function closeLeadModal() {
		$('#lead-modal').removeClass('active');
	}

	function createLead() {
		const data = {
			contact_id: contactId,
			first_name: $('#first_name').val(),
			email: $('#email').val(),
			company: $('#company').val(),
			notes: $('#notes').val()
		};

		frappe.call({
			method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.create_lead_from_portal',
			args: data,
			callback: function(r) {
				if (r.message) {
					frappe.show_alert({
						message: r.message.message,
						indicator: 'green'
					});
					closeLeadModal();
					// Reload page to show lead status
					setTimeout(() => {
						window.location.reload();
					}, 1500);
				}
			},
			error: function(err) {
				frappe.show_alert({
					message: 'Failed to create lead',
					indicator: 'red'
				});
			}
		});
	}

	function escapeHtml(text) {
		if (!text) return '';
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}
</script>

{% endif %}

{% endblock %}
