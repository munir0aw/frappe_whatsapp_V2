<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WhatsApp Portal</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			background-color: #f5f7fa;
			color: #1c1f37;
		}

		/* Layout */
		.portal-container {
			display: flex;
			height: 100vh;
			overflow: hidden;
		}

		/* Sidebar */
		.sidebar {
			width: 240px;
			background-color: #ffffff;
			border-right: 1px solid #e5e7eb;
			display: flex;
			flex-direction: column;
			padding: 20px 0;
		}

		.sidebar-header {
			padding: 0 20px 20px;
			border-bottom: 1px solid #e5e7eb;
		}

		.sidebar-logo {
			display: flex;
			align-items: center;
			gap: 10px;
			font-size: 18px;
			font-weight: 600;
			color: #1c1f37;
		}

		.sidebar-logo-icon {
			width: 32px;
			height: 32px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 8px;
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 18px;
		}

		.sidebar-menu {
			flex: 1;
			padding: 20px 0;
			overflow-y: auto;
		}

		.sidebar-menu-item {
			padding: 10px 20px;
			display: flex;
			align-items: center;
			gap: 12px;
			color: #6b7280;
			cursor: pointer;
			transition: all 0.2s;
			text-decoration: none;
		}

		.sidebar-menu-item:hover {
			background-color: #f3f4f6;
			color: #1c1f37;
		}

		.sidebar-menu-item.active {
			background-color: #eef2ff;
			color: #667eea;
			font-weight: 500;
			border-left: 3px solid #667eea;
		}

		.sidebar-menu-item-icon {
			font-size: 18px;
		}

		.sidebar-footer {
			padding: 20px;
			border-top: 1px solid #e5e7eb;
		}

		/* Main Content */
		.main-content {
			flex: 1;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		/* Top Bar */
		.topbar {
			height: 60px;
			background-color: #ffffff;
			border-bottom: 1px solid #e5e7eb;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 24px;
		}

		.topbar-left {
			display: flex;
			align-items: center;
			gap: 16px;
		}

		.topbar-title {
			font-size: 18px;
			font-weight: 600;
			color: #1c1f37;
		}

		.search-bar {
			width: 300px;
			position: relative;
		}

		.search-input {
			width: 100%;
			padding: 8px 36px 8px 12px;
			border: 1px solid #e5e7eb;
			border-radius: 6px;
			font-size: 14px;
			outline: none;
		}

		.search-input:focus {
			border-color: #667eea;
		}

		.search-icon {
			position: absolute;
			right: 12px;
			top: 50%;
			transform: translateY(-50%);
			color: #9ca3af;
			pointer-events: none;
		}

		.topbar-right {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.topbar-btn {
			padding: 8px 16px;
			border: 1px solid #e5e7eb;
			background-color: #ffffff;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			transition: all 0.2s;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.topbar-btn:hover {
			background-color: #f9fafb;
		}

		.topbar-btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
		}

		.topbar-btn-primary:hover {
			opacity: 0.9;
		}

		/* Content Area */
		.content-area {
			flex: 1;
			overflow-y: auto;
			padding: 24px;
		}

		/* Conversation List */
		.conversation-card {
			background-color: #ffffff;
			border: 1px solid #e5e7eb;
			border-radius: 8px;
			padding: 16px;
			margin-bottom: 12px;
			cursor: pointer;
			transition: all 0.2s;
		}

		.conversation-card:hover {
			border-color: #667eea;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		}

		.conversation-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 8px;
		}

		.conversation-name {
			font-weight: 600;
			font-size: 15px;
			color: #1c1f37;
		}

		.conversation-time {
			font-size: 12px;
			color: #9ca3af;
		}

		.conversation-message {
			font-size: 14px;
			color: #6b7280;
			margin-bottom: 8px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.conversation-footer {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.badge {
			display: inline-block;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: 500;
		}

		.badge-unread {
			background-color: #ef4444;
			color: white;
		}

		.badge-status {
			background-color: #f3f4f6;
			color: #6b7280;
		}

		.badge-converted {
			background-color: #10b981;
			color: white;
		}

		/* Empty State */
		.empty-state {
			text-align: center;
			padding: 60px 20px;
		}

		.empty-state-icon {
			font-size: 64px;
			color: #d1d5db;
			margin-bottom: 16px;
		}

		.empty-state-title {
			font-size: 18px;
			font-weight: 600;
			color: #1c1f37;
			margin-bottom: 8px;
		}

		.empty-state-description {
			font-size: 14px;
			color: #6b7280;
		}

		/* Loading Spinner */
		.loading-spinner {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid #f3f4f6;
			border-top-color: #667eea;
			border-radius: 50%;
			animation: spin 0.8s linear infinite;
		}

		@keyframes spin {
			to { transform: rotate(360deg); }
		}

		@media (max-width: 768px) {
			.sidebar {
				width: 60px;
			}

			.sidebar-menu-item span {
				display: none;
			}

			.search-bar {
				width: 200px;
			}
		}
	</style>
</head>
<body>
	<div class="portal-container">
		<!-- Sidebar -->
		<div class="sidebar">
			<div class="sidebar-header">
				<div class="sidebar-logo">
					<div class="sidebar-logo-icon">üí¨</div>
					<span>WhatsApp</span>
				</div>
			</div>

			<div class="sidebar-menu">
				<a href="#conversations" class="sidebar-menu-item active" data-view="conversations">
					<span class="sidebar-menu-item-icon">üí¨</span>
					<span>Conversations</span>
				</a>
				<a href="#media" class="sidebar-menu-item" data-view="media">
					<span class="sidebar-menu-item-icon">üñºÔ∏è</span>
					<span>Media</span>
				</a>
				<a href="#starred" class="sidebar-menu-item" data-view="starred">
					<span class="sidebar-menu-item-icon">‚≠ê</span>
					<span>Starred</span>
				</a>
			</div>

			<div class="sidebar-footer">
				<a href="/logout" class="sidebar-menu-item">
					<span class="sidebar-menu-item-icon">üö™</span>
					<span>Logout</span>
				</a>
			</div>
		</div>

		<!-- Main Content -->
		<div class="main-content">
			<!-- Top Bar -->
			<div class="topbar">
				<div class="topbar-left">
					<h1 class="topbar-title" id="page-title">Conversations</h1>
					<div class="search-bar">
						<input type="text" class="search-input" placeholder="Search messages..." id="search-input">
						<span class="search-icon">üîç</span>
					</div>
				</div>
				<div class="topbar-right">
					<button class="topbar-btn" id="filter-btn">
						<span>üéØ</span>
						<span>Filter</span>
					</button>
					<button class="topbar-btn" id="sort-btn">
						<span>‚¨ÜÔ∏è</span>
						<span>Sort</span>
					</button>
				</div>
			</div>

			<!-- Content Area -->
			<div class="content-area" id="content-area">
				<!-- Content will be loaded here dynamically -->
			</div>
		</div>
	</div>

	<script>
		// App State
		const app = {
			currentView: 'conversations',
			conversations: [],
			currentContact: null
		};

		// Load conversations on page load
		document.addEventListener('DOMContentLoaded', function() {
			loadConversations();
			setupEventListeners();
		});

		// Setup event listeners
		function setupEventListeners() {
			// Sidebar navigation
			document.querySelectorAll('.sidebar-menu-item[data-view]').forEach(item => {
				item.addEventListener('click', function(e) {
					e.preventDefault();
					const view = this.getAttribute('data-view');
					switchView(view);
				});
			});

			// Search
			let searchTimeout;
			document.getElementById('search-input').addEventListener('input', function() {
				clearTimeout(searchTimeout);
				searchTimeout = setTimeout(() => {
					searchMessages(this.value);
				}, 500);
			});
		}

		// Switch views
		function switchView(view) {
			app.currentView = view;

			// Update active menu item
			document.querySelectorAll('.sidebar-menu-item').forEach(item => {
				item.classList.remove('active');
			});
			document.querySelector(`[data-view="${view}"]`).classList.add('active');

			// Update page title
			const titles = {
				'conversations': 'Conversations',
				'media': 'Media Gallery',
				'starred': 'Starred Messages'
			};
			document.getElementById('page-title').textContent = titles[view];

			// Load content
			switch(view) {
				case 'conversations':
					loadConversations();
					break;
				case 'media':
					loadMediaGallery();
					break;
				case 'starred':
					loadStarredMessages();
					break;
			}
		}

		// Load conversations
		function loadConversations() {
			showLoading();

			frappe.call({
				method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.get_my_conversations',
				callback: function(r) {
					if (r.message && r.message.length > 0) {
						app.conversations = r.message;
						renderConversations(r.message);
					} else {
						showEmptyState('No conversations found', 'Start a conversation via WhatsApp to see it here');
					}
				},
				error: function(err) {
					showError('Failed to load conversations');
				}
			});
		}

		// Render conversations
		function renderConversations(conversations) {
			const html = conversations.map(conv => {
				const time = moment(conv.last_message_date).fromNow();
				const unreadBadge = conv.unread_count > 0 ? 
					`<span class="badge badge-unread">${conv.unread_count} new</span>` : '';
				const convertedBadge = conv.converted_to_lead ? 
					`<span class="badge badge-converted">‚úì Lead Created</span>` : '';

				return `
					<div class="conversation-card" onclick="openConversation('${conv.name}')">
						<div class="conversation-header">
							<div class="conversation-name">${conv.contact_name || conv.mobile_no}</div>
							<div class="conversation-time">${time}</div>
						</div>
						<div class="conversation-message">${conv.last_message || 'No messages yet'}</div>
						<div class="conversation-footer">
							${unreadBadge}
							<span class="badge badge-status">${conv.qualification_status}</span>
							${convertedBadge}
						</div>
					</div>
				`;
			}).join('');

			document.getElementById('content-area').innerHTML = html;
		}

		// Open conversation detail
		function openConversation(contactId) {
			window.location.href = `/whatsapp/conversation?contact=${encodeURIComponent(contactId)}`;
		}

		// Load media gallery
		function loadMediaGallery() {
			showLoading();

			frappe.call({
				method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.get_media_gallery',
				callback: function(r) {
					if (r.message && r.message.length > 0) {
						renderMediaGallery(r.message);
					} else {
						showEmptyState('No media found', 'Shared images, videos, and documents will appear here');
					}
				}
			});
		}

		// Render media gallery
		function renderMediaGallery(media) {
			const html = `
				<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
					${media.map(item => `
						<div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
							${item.content_type === 'image' ? 
								`<img src="${item.attach}" style="width: 100%; height: 200px; object-fit: cover;">` :
								`<div style="height: 200px; display: flex; align-items: center; justify-content: center; background: #f3f4f6;">
									<span style="font-size: 48px;">üìÑ</span>
								</div>`
							}
							<div style="padding: 12px;">
								<div style="font-size: 12px; color: #6b7280;">${moment(item.creation).format('MMM D, YYYY')}</div>
							</div>
						</div>
					`).join('')}
				</div>
			`;

			document.getElementById('content-area').innerHTML = html;
		}

		// Load starred messages
		function loadStarredMessages() {
			showLoading();

			frappe.call({
				method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.get_starred_messages',
				callback: function(r) {
					if (r.message && r.message.length > 0) {
						renderStarredMessages(r.message);
					} else {
						showEmptyState('No starred messages', 'Star important messages to find them quickly');
					}
				}
			});
		}

		// Render starred messages
		function renderStarredMessages(messages) {
			const html = messages.map(msg => `
				<div class="conversation-card">
					<div class="conversation-header">
						<div class="conversation-name">${msg.type === 'Incoming' ? 'Received' : 'Sent'}</div>
						<div class="conversation-time">${moment(msg.creation).format('MMM D, YYYY HH:mm')}</div>
					</div>
					<div class="conversation-message">${msg.message || '(Media message)'}</div>
				</div>
			`).join('');

			document.getElementById('content-area').innerHTML = html;
		}

		// Search messages
		function searchMessages(query) {
			if (!query) {
				loadConversations();
				return;
			}

			showLoading();

			frappe.call({
				method: 'frappe_whatsapp.frappe_whatsapp.api.portal_api.search_messages',
				args: { query: query },
				callback: function(r) {
					if (r.message && r.message.length > 0) {
						renderSearchResults(r.message);
					} else {
						showEmptyState('No results found', `No messages found for "${query}"`);
					}
				}
			});
		}

		// Render search results
		function renderSearchResults(messages) {
			const html = messages.map(msg => `
				<div class="conversation-card">
					<div class="conversation-header">
						<div class="conversation-name">${msg.type === 'Incoming' ? 'Received' : 'Sent'}</div>
						<div class="conversation-time">${moment(msg.creation).format('MMM D, YYYY HH:mm')}</div>
					</div>
					<div class="conversation-message">${msg.message || '(Media message)'}</div>
				</div>
			`).join('');

			document.getElementById('content-area').innerHTML = html;
		}

		// Show loading state
		function showLoading() {
			document.getElementById('content-area').innerHTML = `
				<div class="empty-state">
					<div class="loading-spinner"></div>
					<div class="empty-state-description" style="margin-top: 16px;">Loading...</div>
				</div>
			`;
		}

		// Show empty state
		function showEmptyState(title, description) {
			document.getElementById('content-area').innerHTML = `
				<div class="empty-state">
					<div class="empty-state-icon">üì≠</div>
					<div class="empty-state-title">${title}</div>
					<div class="empty-state-description">${description}</div>
				</div>
			`;
		}

		// Show error
		function showError(message) {
			document.getElementById('content-area').innerHTML = `
				<div class="empty-state">
					<div class="empty-state-icon">‚ùå</div>
					<div class="empty-state-title">Error</div>
					<div class="empty-state-description">${message}</div>
				</div>
			`;
		}
	</script>
</body>
</html>
